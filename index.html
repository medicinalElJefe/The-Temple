<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Acausal Elemental Sound Engine · Final Build</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #050510;
      --bg-alt: #0b0b1a;
      --card: #111124;
      --accent: #7f5af0;
      --accent-soft: rgba(127,90,240,0.22);
      --danger: #ff3366;
      --text: #f6f6ff;
      --muted: #9da3c7;
      --border: #232343;
    }
    body.light {
      --bg: #f5f5ff;
      --bg-alt: #e7e7f8;
      --card: #ffffff;
      --accent: #3366ff;
      --accent-soft: #ffb34733;
      --danger: #e03e6f;
      --text: #11111a;
      --muted: #555577;
      --border: #d0d0ea;
    }
    * { box-sizing:border-box; }
    body {
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #181830 0, var(--bg) 60%);
      color:var(--text);
    }
    header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 16px;
      border-bottom:1px solid var(--border);
      backdrop-filter: blur(12px);
      position:sticky;
      top:0;
      z-index:10;
      background:linear-gradient(to bottom, rgba(5,5,16,0.96), rgba(5,5,16,0.88));
    }
    .title {
      font-weight:600;
      letter-spacing:0.08em;
      text-transform:uppercase;
      font-size:0.76rem;
      opacity:0.9;
    }
    .header-controls {
      display:flex;
      gap:6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .pill {
      border-radius:999px;
      border:1px solid var(--border);
      padding:3px 10px;
      font-size:0.72rem;
      color:var(--muted);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    main {
      padding:12px 10px 40px;
      max-width:1240px;
      margin:0 auto;
    }
    .grid {
      display:grid;
      grid-template-columns: minmax(0,1.1fr) minmax(0,1.2fr) minmax(0,1.1fr);
      gap:10px;
    }
    @media(max-width:960px){
      .grid { grid-template-columns:1fr; }
    }
    .card {
      background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)), var(--card);
      border-radius:14px;
      border:1px solid #ffffff14;
      padding:10px 10px 12px;
      box-shadow:0 18px 50px rgba(0,0,0,0.45);
    }
    .section-label {
      font-size:0.8rem;
      font-weight:600;
      letter-spacing:0.11em;
      text-transform:uppercase;
      color:var(--muted);
      margin-bottom:6px;
    }
    .small { font-size:0.78rem; color:var(--muted); }
    .label-pill {
      font-size:0.72rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted);
    }
    .btn, .btn-ghost, .btn-secondary {
      border-radius:999px;
      border:1px solid var(--accent);
      background:var(--accent-soft);
      color:var(--text);
      padding:6px 14px;
      font-size:0.76rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .btn-ghost {
      border-color:var(--border);
      background:transparent;
      color:var(--muted);
    }
    .btn-secondary {
      background:var(--accent);
      color:#fff;
    }
    .btn:disabled, .btn-ghost:disabled, .btn-secondary:disabled {
      opacity:0.5; cursor:default;
    }
    textarea {
      width:100%;
      min-height:80px;
      resize:vertical;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--bg-alt);
      color:var(--text);
      padding:6px 8px;
      font-size:0.78rem;
    }
    input[type="date"], select, input[type="number"] {
      width:100%;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--bg-alt);
      color:var(--text);
      padding:4px 8px;
      font-size:0.78rem;
    }
    input[type="date"]::-webkit-calendar-picker-indicator {
      filter:invert(0.7);
    }
    .stack { display:flex; flex-direction:column; gap:6px; }
    .row { display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
    .badge {
      display:inline-flex;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:0.7rem;
      color:var(--muted);
      gap:4px;
      align-items:center;
    }
    .chat-log {
      max-height:210px;
      overflow:auto;
      border-radius:10px;
      border:1px solid var(--border);
      padding:6px;
      background:radial-gradient(circle at top left, rgba(127,90,240,0.15), transparent 55%);
      font-size:0.78rem;
    }
    .chat-msg-user { margin-bottom:4px; }
    .chat-msg-user span {
      display:inline-block;
      padding:4px 8px;
      border-radius:10px;
      background:rgba(127,90,240,0.24);
    }
    .chat-msg-system span {
      display:inline-block;
      padding:4px 8px;
      border-radius:10px;
      background:rgba(255,255,255,0.05);
      color:var(--muted);
    }
    .hub-tabs {
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:6px;
    }
    .hub-tab-btn {
      flex:0 0 auto;
      border-radius:16px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--muted);
      font-size:0.78rem;
      padding:4px 10px;
      cursor:pointer;
    }
    .hub-tab-btn-active {
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .hub-tab { display:none; }
    .hub-tab-active { display:block; }
    canvas {
      width:100%;
      height:160px;
      border-radius:10px;
      background:radial-gradient(circle at center, #202048 0, #050510 65%);
      border:1px solid var(--border);
    }
    table {
      border-collapse:collapse;
      width:100%;
    }
    th, td {
      font-size:0.74rem;
      padding:2px 3px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      text-align:left;
    }
    th { color:var(--muted); }
  </style>
</head>
<body>
  <header>
    <div class="title">ACΛUSΛL ELEMENTAL SOUND ENGINE · FINAL BUILD</div>
    <div class="header-controls">
      <button class="pill" id="themeBtn">Theme</button>
      <span class="pill" id="modePill" style="display:none;">Stable engine</span>
    </div>
  </header>
  <main>
    <div class="grid">
      <!-- LEFT: Chat + intent -->
      <section class="card">
        <div class="section-label">Intent & reflection</div>
        <p class="small">
          Describe how your body, mind, and emotions feel. The field uses this as part of the vector that shapes sound and geometry.
        </p>
        <textarea id="chatInput" placeholder="Example: I feel pressure in my chest and racing thoughts, but also hope."></textarea>
        <div class="row" style="margin-top:4px; justify-content:space-between;">
          <button class="btn-ghost" id="chatSendBtn">Add to field</button>
          <span class="small" id="intentSummary">No intent added yet.</span>
        </div>
        <div class="chat-log" id="chatLog" style="margin-top:8px;"></div>

        <hr style="border:none;border-top:1px solid var(--border);margin:8px 0;" />

        <div class="section-label">Self ratings</div>
        <div class="stack">
          <label class="small">Body tension (0–10)</label>
          <input type="number" id="rateBody" min="0" max="10" step="1" value="5">
          <label class="small">Mind noise (0–10)</label>
          <input type="number" id="rateMind" min="0" max="10" step="1" value="5">
          <label class="small">Emotional charge (0–10)</label>
          <input type="number" id="rateEmotion" min="0" max="10" step="1" value="5">
        </div>
      </section>

      <!-- CENTER: Breath + sound -->
      <section class="card">
        <div class="hub-tabs">
          <button class="hub-tab-btn hub-tab-btn-active" data-hub-tab="breath">4-6-8 Breath</button>
          <button class="hub-tab-btn" data-hub-tab="sound">Sound & Geometry</button>
        </div>

        <div class="hub-tab hub-tab-active" id="hubTab-breath">
          <div class="section-label">Step 2 · 4-6-8 Coherence Breath</div>
          <p class="small">
            Inhale through the nose for 4 counts, hold gently for 6, then exhale through the mouth for 8.
            Let your shoulders drop as you exhale. This stabilizes the nervous system and entrains the sound field.
          </p>
          <div class="row" style="margin-top:6px;">
            <button class="btn-secondary" id="breathStartBtn">Start 4-6-8 cycle</button>
            <button class="btn-ghost" id="breathNextBtn">Next phase</button>
            <button class="btn-ghost" id="breathStopBtn">Stop coach</button>
          </div>
          <p class="small" id="breathPhaseLabel" style="margin-top:6px;">Not running.</p>
          <p class="small" id="breathTimerLabel">Ready.</p>
        </div>

        <div class="hub-tab" id="hubTab-sound">
          <div class="section-label">Step 3 · Sound field & geometry</div>
          <p class="small">
            This generates a pink-noise based field plus harmonic tones tied to Fire, Earth, Air, Water, Aether, and Field.
            Session mode, engine mode, and your vector shape how it sounds.
          </p>

          <div style="margin:6px 0;">
            <span class="label-pill">Session mode</span>
            <div class="row" style="margin-top:4px;">
              <button class="btn-ghost" data-session-mode="reset">Reset</button>
              <button class="btn-ghost" data-session-mode="sleep">Sleep</button>
              <button class="btn-ghost" data-session-mode="focus">Focus</button>
              <button class="btn-ghost" data-session-mode="heart">Heart</button>
            </div>
            <p class="small" id="sessionModeHelp" style="margin-top:4px;">
              Reset: gentle coherence for the nervous system.
            </p>
          </div>

          <div style="margin-top:6px;margin-bottom:4px;">
            <span class="label-pill">Voice influence</span>
            <div class="row" style="margin-top:4px;">
              <button class="btn-ghost" data-voice-mode="off">Off</button>
              <button class="btn-ghost" data-voice-mode="scan">Calibration scan</button>
              <button class="btn-ghost" data-voice-mode="live">Live adaptive</button>
            </div>
            <p class="small" id="voiceModeHelp" style="margin-top:4px;">
              Use voice influence later when microphone analysis is enabled on your device.
            </p>
          </div>

          <div style="margin-top:6px;margin-bottom:2px;">
            <button class="btn-ghost" id="engineModeBtn">Engine: Stable</button>
            <p class="small" style="margin-top:4px;">
              Stable = smooth and battery-friendly. Pro = fuller harmonics and spatial motion.
            </p>
          </div>

          <label style="font-size:0.78rem;display:block;margin-top:8px;margin-bottom:4px;">
            <input type="checkbox" id="mirrorMode" /> Mirror mode (tilt field toward your current expression)
          </label>

          <div class="row" style="margin-top:6px;flex-wrap:wrap;gap:6px;">
            <button class="btn-secondary" id="startAudioBtn">Start sound field</button>
            <button class="btn-ghost" id="stopAudioBtn">Stop</button>
            <button class="btn-ghost" id="testToneBtn">Test tone</button>
          </div>
          <p class="small" id="audioStatus" style="margin-top:6px;">No sound session running.</p>
        </div>
      </section>

      <!-- RIGHT: Geometry + horoscope -->
      <section class="card">
        <div class="section-label">Geometry & field</div>
        <canvas id="geoCanvas"></canvas>
        <p class="small" id="geoLabel" style="margin-top:4px;">Dominant shape: none yet.</p>

        <hr style="border:none;border-top:1px solid var(--border);margin:10px 0;" />

        <div class="section-label">Elemental horoscope</div>
        <p class="small">
          Birth data defines your natal element pattern. The current sound field expresses your present mix.
          The delta between them suggests which element/geometry to emphasize.
        </p>
        <label class="small">Birth date (for Sun-based natal profile)</label>
        <input type="date" id="natalBirthDate" />
        <button class="btn-ghost" id="natalSaveBtn" style="margin-top:4px;">Save birth data</button>
        <p class="small" id="natalInfo" style="margin-top:4px;">No natal profile computed yet.</p>

        <button class="btn-secondary" id="horoscopeUpdateBtn" style="margin-top:8px;">
          Update from current sound field
        </button>
        <p class="small" id="horoscopeSummary" style="margin-top:6px;">
          Start a sound session, then tap update to see your elemental coherence map.
        </p>
        <div id="horoscopeDetails" class="small" style="margin-top:6px;"></div>
      </section>
    </div>
  </main>

  <script>
    // ---------- BASIC STATE ----------
    let ashEngineMode = "stable";
    let ashSessionMode = "reset";
    let ashVoiceMode = "off";
    let ashNatalProfile = null;
    let ashLastCurrentProfile = null;
    let ashHoroscope = null;
    let lastIntentText = "";

    // ---------- AUDIO ENGINE STATE ----------
    let audioCtx = null;
    let masterGain = null;
    let noiseNode = null;
    let toneGains = [];
    let runningRecipe = null;

    const ELEMENT_BASE_FREQ = {
      fire: 432,
      earth: 270,
      air: 540,
      water: 180,
      aether: 216,
      field: 111
    };

    function clamp(v,min,max){ return v<min?min:(v>max?max:v); }

    // ---------- THEME ----------
    document.getElementById("themeBtn").addEventListener("click", ()=>{
      document.body.classList.toggle("light");
    });

    // ---------- CHAT ----------
    function appendChat(role, text){
      const log = document.getElementById("chatLog");
      if (!log) return;
      const div = document.createElement("div");
      div.className = role==="user" ? "chat-msg-user" : "chat-msg-system";
      const span = document.createElement("span");
      span.textContent = text;
      div.appendChild(span);
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    document.getElementById("chatSendBtn").addEventListener("click", ()=>{
      const input = document.getElementById("chatInput");
      const val = (input.value || "").trim();
      if (!val) return;
      lastIntentText = val;
      appendChat("user", val);
      // Simple reflective stub
      appendChat("system", "Intent acknowledged. This will bias the field toward the themes you described.");
      document.getElementById("intentSummary").textContent = "Intent loaded into field.";
      input.value = "";
    });

    // ---------- HUB TABS ----------
    document.querySelectorAll(".hub-tab-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const target = btn.getAttribute("data-hub-tab");
        document.querySelectorAll(".hub-tab-btn").forEach(b=>b.classList.remove("hub-tab-btn-active"));
        btn.classList.add("hub-tab-btn-active");
        document.querySelectorAll(".hub-tab").forEach(tab=>{
          if (tab.id === "hubTab-"+target) tab.classList.add("hub-tab-active");
          else tab.classList.remove("hub-tab-active");
        });
      });
    });

    // ---------- BREATH COACH ----------
    let breathPhase = null;
    let breathTimer = null;
    let breathRemaining = 0;

    function updateBreathLabels(){
      const phaseLabel = document.getElementById("breathPhaseLabel");
      const timerLabel = document.getElementById("breathTimerLabel");
      if (!breathPhase) {
        phaseLabel.textContent = "Not running.";
        timerLabel.textContent = "Ready.";
        return;
      }
      phaseLabel.textContent = "Phase: " + breathPhase.toUpperCase();
      timerLabel.textContent = breathRemaining + " s";
    }

    function nextBreathPhase(){
      if (!breathPhase || breathPhase === "exhale") {
        breathPhase = "inhale"; breathRemaining = 4;
      } else if (breathPhase === "inhale") {
        breathPhase = "hold"; breathRemaining = 6;
      } else if (breathPhase === "hold") {
        breathPhase = "exhale"; breathRemaining = 8;
      }
      updateBreathLabels();
    }

    document.getElementById("breathStartBtn").addEventListener("click", ()=>{
      if (breathTimer) clearInterval(breathTimer);
      nextBreathPhase();
      breathTimer = setInterval(()=>{
        if (!breathPhase) return;
        breathRemaining -= 1;
        if (breathRemaining <= 0){
          nextBreathPhase();
        } else {
          updateBreathLabels();
        }
      }, 1000);
    });

    document.getElementById("breathNextBtn").addEventListener("click", ()=>{
      nextBreathPhase();
    });

    document.getElementById("breathStopBtn").addEventListener("click", ()=>{
      breathPhase = null;
      if (breathTimer) clearInterval(breathTimer);
      breathTimer = null;
      updateBreathLabels();
    });
    updateBreathLabels();

    // ---------- SESSION MODES ----------
    const sessionModeHelp = document.getElementById("sessionModeHelp");
    document.querySelectorAll("[data-session-mode]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        ashSessionMode = btn.getAttribute("data-session-mode");
        document.querySelectorAll("[data-session-mode]").forEach(b=>b.classList.remove("btn-secondary"));
        btn.classList.add("btn-secondary");
        if (ashSessionMode === "reset") {
          sessionModeHelp.textContent = "Reset: gentle coherence for the nervous system.";
        } else if (ashSessionMode === "sleep") {
          sessionModeHelp.textContent = "Sleep: slower, softer field tuned for winding down.";
        } else if (ashSessionMode === "focus") {
          sessionModeHelp.textContent = "Focus: clearer harmonics and steady rhythm.";
        } else if (ashSessionMode === "heart") {
          sessionModeHelp.textContent = "Heart: gentle theta/alpha mix for emotional flow.";
        }
      });
    });
    // default:
    const resetBtn = document.querySelector('[data-session-mode="reset"]');
    if (resetBtn) resetBtn.click();

    // ---------- VOICE MODE (for future expansion) ----------
    const voiceModeHelp = document.getElementById("voiceModeHelp");
    document.querySelectorAll("[data-voice-mode]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        ashVoiceMode = btn.getAttribute("data-voice-mode");
        document.querySelectorAll("[data-voice-mode]").forEach(b=>b.classList.remove("btn-secondary"));
        btn.classList.add("btn-secondary");
        if (ashVoiceMode === "off") {
          voiceModeHelp.textContent = "Voice influence off. Field is driven by intent, session mode, and ratings.";
        } else if (ashVoiceMode === "scan") {
          voiceModeHelp.textContent = "Calibration scan: speak for 20–40 seconds (future feature).";
        } else if (ashVoiceMode === "live") {
          voiceModeHelp.textContent = "Live adaptive: field responds continuously to your voice (future feature).";
        }
      });
    });
    const vmOffBtn = document.querySelector('[data-voice-mode="off"]');
    if (vmOffBtn) vmOffBtn.click();

    // ---------- ENGINE MODE TOGGLE ----------
    function updateEngineModeUI(){
      const btn = document.getElementById("engineModeBtn");
      if (!btn) return;
      if (ashEngineMode === "pro") {
        btn.textContent = "Engine: Pro";
        btn.classList.add("btn-secondary");
        const pill = document.getElementById("modePill");
        if (pill){ pill.style.display="inline-flex"; pill.textContent="Pro engine"; }
      } else {
        ashEngineMode = "stable";
        btn.textContent = "Engine: Stable";
        btn.classList.remove("btn-secondary");
        const pill = document.getElementById("modePill");
        if (pill){ pill.style.display="inline-flex"; pill.textContent="Stable engine"; }
      }
    }

    document.getElementById("engineModeBtn").addEventListener("click", ()=>{
      ashEngineMode = (ashEngineMode === "stable") ? "pro" : "stable";
      updateEngineModeUI();
    });
    updateEngineModeUI();

    // ---------- NATAL PROFILE (SUN-BASED) ----------
    function ashGetZodiacSignFromDate(dateStr){
      if(!dateStr) return null;
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return null;
      const m = d.getUTCMonth() + 1;
      const day = d.getUTCDate();
      if ((m === 3  && day >= 21) || (m === 4 && day <= 19)) return "Aries";
      if ((m === 4  && day >= 20) || (m === 5 && day <= 20)) return "Taurus";
      if ((m === 5  && day >= 21) || (m === 6 && day <= 20)) return "Gemini";
      if ((m === 6  && day >= 21) || (m === 7 && day <= 22)) return "Cancer";
      if ((m === 7  && day >= 23) || (m === 8 && day <= 22)) return "Leo";
      if ((m === 8  && day >= 23) || (m === 9 && day <= 22)) return "Virgo";
      if ((m === 9  && day >= 23) || (m === 10 && day <= 22)) return "Libra";
      if ((m === 10 && day >= 23) || (m === 11 && day <= 21)) return "Scorpio";
      if ((m === 11 && day >= 22) || (m === 12 && day <= 21)) return "Sagittarius";
      if ((m === 12 && day >= 22) || (m === 1 && day <= 19)) return "Capricorn";
      if ((m === 1  && day >= 20) || (m === 2 && day <= 18)) return "Aquarius";
      if ((m === 2  && day >= 19) || (m === 3 && day <= 20)) return "Pisces";
      return null;
    }

    function ashElementFromSign(sign){
      if (!sign) return null;
      if (["Aries","Leo","Sagittarius"].includes(sign)) return "fire";
      if (["Taurus","Virgo","Capricorn"].includes(sign)) return "earth";
      if (["Gemini","Libra","Aquarius"].includes(sign)) return "air";
      if (["Cancer","Scorpio","Pisces"].includes(sign)) return "water";
      return null;
    }

    function ashComputeNatalProfileFromBirthDate(dateStr){
      const sign = ashGetZodiacSignFromDate(dateStr);
      const element = ashElementFromSign(sign);
      if (!element) return null;
      let fireRaw=0, earthRaw=0, airRaw=0, waterRaw=0;
      if (element === "fire") fireRaw = 1;
      if (element === "earth") earthRaw = 1;
      if (element === "air") airRaw = 1;
      if (element === "water") waterRaw = 1;
      const aetherRaw = (airRaw + waterRaw)/2;
      const fieldRaw  = (fireRaw + earthRaw)/2;
      let totalRaw = fireRaw + earthRaw + airRaw + waterRaw + aetherRaw + fieldRaw;
      if (totalRaw <= 0) totalRaw = 1;
      return {
        fire:  fireRaw / totalRaw,
        earth: earthRaw / totalRaw,
        air:   airRaw / totalRaw,
        water: waterRaw / totalRaw,
        aether: aetherRaw / totalRaw,
        field:  fieldRaw / totalRaw,
        sign,
        element,
        fullChartUsed: false
      };
    }

    // Placeholder for full chart mode (Moon, Asc, planets)
    const PLANET_WEIGHTS = {
      sun:3.0, moon:3.0, asc:3.0,
      mercury:1.5, venus:1.5, mars:1.5,
      jupiter:1.0, saturn:1.0,
      uranus:0.8, neptune:0.8, pluto:0.8
    };
    function ashComputeNatalProfileFromChart(chart){
      let fireRaw=0, earthRaw=0, airRaw=0, waterRaw=0;
      const contrib = {};
      Object.keys(chart||{}).forEach(key=>{
        const sign = chart[key];
        const el = ashElementFromSign(sign);
        contrib[key] = { sign, element: el };
        const w = PLANET_WEIGHTS[key] || 1.0;
        if (el === "fire") fireRaw += w;
        if (el === "earth") earthRaw += w;
        if (el === "air") airRaw += w;
        if (el === "water") waterRaw += w;
      });
      const aetherRaw = (airRaw + waterRaw)/2;
      const fieldRaw  = (fireRaw + earthRaw)/2;
      let totalRaw = fireRaw + earthRaw + airRaw + waterRaw + aetherRaw + fieldRaw;
      if (totalRaw <= 0) totalRaw = 1;
      const sunSign = chart && chart.sun;
      const sunElement = ashElementFromSign(sunSign);
      return {
        fire:  fireRaw / totalRaw,
        earth: earthRaw / totalRaw,
        air:   airRaw / totalRaw,
        water: waterRaw / totalRaw,
        aether: aetherRaw / totalRaw,
        field:  fieldRaw / totalRaw,
        sign: sunSign || null,
        element: sunElement || null,
        fullChartUsed: true,
        planetContrib: contrib
      };
    }

    function ashComputeHoroscope(natal, current){
      if (!natal || !current) return null;
      function pct(x){ return x*100; }
      const elems = ["fire","earth","air","water","aether","field"];
      const desc = {};
      elems.forEach(el=>{
        const n = natal[el] || 0;
        const c = current[el] || 0;
        const delta = n - c;
        let prescription = "Maintain coherence";
        if (el === "fire") {
          if (delta > 0.15) prescription = "Activate Fire (Tetrahedron)";
          else if (delta < -0.15) prescription = "Purify Water (Icosahedron)";
        } else if (el === "earth") {
          if (delta > 0.15) prescription = "Activate Earth (Cube)";
          else if (delta < -0.15) prescription = "Purify Air (Octahedron)";
        } else if (el === "air") {
          if (delta > 0.15) prescription = "Activate Air (Octahedron)";
          else if (delta < -0.15) prescription = "Ground Earth (Cube)";
        } else if (el === "water") {
          if (delta > 0.15) prescription = "Activate Water (Icosahedron)";
          else if (delta < -0.15) prescription = "Ignite Fire (Tetrahedron)";
        } else if (el === "aether") {
          if (delta > 0.15) prescription = "Activate Aether (Dodecahedron)";
          else if (delta < -0.15) prescription = "Secure Field (Torus/Sphere)";
        } else if (el === "field") {
          if (delta > 0.15) prescription = "Secure Field (Torus/Sphere)";
          else if (delta < -0.15) prescription = "Expand Aether (Dodecahedron)";
        }
        desc[el] = { natal:n, current:c, natalPct:pct(n), currentPct:pct(c), delta, prescription };
      });
      let maxAbs = 0;
      let urgentEl = null;
      let urgent = null;
      Object.keys(desc).forEach(el=>{
        const d = desc[el].delta;
        const a = Math.abs(d);
        if (a > maxAbs){
          maxAbs = a;
          urgentEl = el;
          urgent = desc[el];
        }
      });
      return {
        natal,
        current,
        byElement: desc,
        urgentElement: urgentEl,
        urgentDelta: maxAbs,
        urgent
      };
    }

    function ashRenderHoroscopeUI(){
      const summaryEl = document.getElementById("horoscopeSummary");
      const detailsEl = document.getElementById("horoscopeDetails");
      if (!summaryEl || !detailsEl) return;
      if (!ashHoroscope || !ashHoroscope.urgent) {
        summaryEl.textContent = "No horoscope yet. Save your birth date and update from the current field.";
        detailsEl.innerHTML = "";
        return;
      }
      const h = ashHoroscope;
      const u = h.urgent;
      const elNameMap = {
        fire: "Fire",
        earth: "Earth",
        air: "Air",
        water: "Water",
        aether: "Aether",
        field: "Field"
      };
      const elName = elNameMap[h.urgentElement] || h.urgentElement;
      const deltaPct = (u.delta*100).toFixed(1);
      summaryEl.textContent = "Urgent focus: " + elName + " (Δ = " + deltaPct +
        " pts vs natal). Suggested: " + u.prescription + ".";
      let html = "<table><tr><th>Element</th><th>Natal %</th><th>Current %</th><th>Δ</th><th>Prescription</th></tr>";
      Object.keys(h.byElement).forEach(key=>{
        const row = h.byElement[key];
        html += "<tr>";
        html += "<td>" + (elNameMap[key]||key) + "</td>";
        html += "<td>" + row.natalPct.toFixed(1) + "%</td>";
        html += "<td>" + row.currentPct.toFixed(1) + "%</td>";
        html += "<td>" + (row.delta*100).toFixed(1) + "</td>";
        html += "<td>" + row.prescription + "</td>";
        html += "</tr>";
      });
      html += "</table>";
      detailsEl.innerHTML = html;
    }

    // ---------- NATAL UI ----------
    (function setupNatalUI(){
      const birthInput = document.getElementById("natalBirthDate");
      const saveBtn = document.getElementById("natalSaveBtn");
      const info = document.getElementById("natalInfo");
      if (!birthInput || !saveBtn || !info) return;
      const storedDob = localStorage.getItem("ash_birth_date_simple");
      if (storedDob) {
        birthInput.value = storedDob;
        const prof = ashComputeNatalProfileFromBirthDate(storedDob);
        if (prof) {
          ashNatalProfile = prof;
          info.textContent = "Natal Sun: " + prof.sign + " (" + prof.element.toUpperCase() + "). Profile saved.";
        }
      }
      saveBtn.addEventListener("click", ()=>{
        const dob = birthInput.value;
        const prof = ashComputeNatalProfileFromBirthDate(dob);
        if (!prof) {
          info.textContent = "Could not compute a natal profile from that date.";
          return;
        }
        ashNatalProfile = prof;
        localStorage.setItem("ash_birth_date_simple", dob);
        info.textContent = "Natal Sun: " + prof.sign + " (" + prof.element.toUpperCase() + "). Profile saved.";
      });
      document.getElementById("horoscopeUpdateBtn").addEventListener("click", ()=>{
        if (!ashNatalProfile) {
          alert("Set your birth date first to compute a natal profile.");
          return;
        }
        if (!ashLastCurrentProfile) {
          alert("Start a sound field at least once so I can read your current elements.");
          return;
        }
        ashHoroscope = ashComputeHoroscope(ashNatalProfile, ashLastCurrentProfile);
        ashRenderHoroscopeUI();
      });
    })();

    // ---------- SIMPLE ELEMENT WEIGHTS FROM SESSION + RATINGS ----------
    function buildElementWeights(){
      // Base from session mode
      let w = {fire:1,earth:1,air:1,water:1,aether:1,field:1};
      if (ashSessionMode === "reset"){
        w.water += 1; w.field += 1;
      } else if (ashSessionMode === "sleep"){
        w.water += 1.5; w.field += 1.2; w.air -= 0.5; w.fire -= 0.5;
      } else if (ashSessionMode === "focus"){
        w.air += 1.5; w.fire += 1.0; w.water -= 0.5;
      } else if (ashSessionMode === "heart"){
        w.water += 1.2; w.aether += 1.2; w.field += 0.4;
      }
      const body = parseFloat(document.getElementById("rateBody").value||"5");
      const mind = parseFloat(document.getElementById("rateMind").value||"5");
      const emo  = parseFloat(document.getElementById("rateEmotion").value||"5");
      // crude mapping
      w.earth += clamp((10-body)/10,0,1);
      w.field += clamp((10-body)/10,0,1);
      w.fire  += clamp(body/10,0,1);
      w.air   += clamp(mind/10,0,1);
      w.water += clamp(emo/10,0,1);
      w.aether += clamp((mind+emo)/20,0,1);

      // Mirror mode: let "over"-expressed ratings tilt more into Fire/Air, under into Earth/Field
      if (document.getElementById("mirrorMode").checked){
        w.fire  += body>6?0.4:0;
        w.air   += mind>6?0.4:0;
        w.water += emo>6?0.4:0;
      }

      // Normalize
      let sum = 0;
      Object.values(w).forEach(v=>sum+=Math.max(0,v));
      if (sum<=0) sum=1;
      Object.keys(w).forEach(k=>w[k]=Math.max(0,w[k])/sum);
      return w;
    }

    // ---------- AUDIO ENGINE ----------
    function ensureAudioCtx(){
      if (audioCtx) return audioCtx;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      masterGain = audioCtx.createGain();
      masterGain.gain.value = (ashEngineMode==="pro")?1.0:0.9;
      masterGain.connect(audioCtx.destination);
      return audioCtx;
    }

    function createPinkNoiseNode(ctx){
      // Simple pink-ish noise using random + 1/f shaping
      const bufferSize = 4096;
      const node = ctx.createScriptProcessor(bufferSize,1,1);
      let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
      node.onaudioprocess = function(e){
        const out = e.outputBuffer.getChannelData(0);
        for (let i=0;i<bufferSize;i++){
          const white = Math.random()*2-1;
          b0 = 0.99886 * b0 + white * 0.0555179;
          b1 = 0.99332 * b1 + white * 0.0750759;
          b2 = 0.96900 * b2 + white * 0.1538520;
          b3 = 0.86650 * b3 + white * 0.3104856;
          b4 = 0.55000 * b4 + white * 0.5329522;
          b5 = -0.7616 * b5 - white * 0.0168980;
          const pink = b0 + b1 + b2 + b3 + b4 + b5 + b6 + white*0.5362;
          b6 = white*0.115926;
          out[i] = pink*0.11;
        }
      };
      return node;
    }

    function startAudioSession(){
      if (runningRecipe) return;
      const ctx = ensureAudioCtx();
      const recipe = {};
      const elementWeights = buildElementWeights();

      // Determine dominant element & geometry label
      let maxEl = "fire"; let maxVal = 0;
      Object.keys(elementWeights).forEach(k=>{
        if (elementWeights[k]>maxVal){ maxVal = elementWeights[k]; maxEl = k; }
      });
      const geoMap = {
        fire:"Tetrahedron (Fire)",
        earth:"Cube (Earth)",
        air:"Octahedron (Air)",
        water:"Icosahedron (Water)",
        aether:"Dodecahedron (Aether)",
        field:"Torus/Sphere (Field)"
      };
      document.getElementById("geoLabel").textContent = "Dominant shape: " + (geoMap[maxEl]||maxEl);

      // Expose current profile for horoscope
      ashLastCurrentProfile = {
        fire:elementWeights.fire, earth:elementWeights.earth, air:elementWeights.air,
        water:elementWeights.water, aether:elementWeights.aether, field:elementWeights.field
      };

      // Build frequency set from weighted bases
      let freqs = [];
      Object.keys(ELEMENT_BASE_FREQ).forEach(el=>{
        const base = ELEMENT_BASE_FREQ[el];
        const weight = elementWeights[el];
        const count = (ashEngineMode==="pro") ? Math.round(3*weight)+2 : Math.round(2*weight)+1;
        for (let h=1; h<=count; h++){
          freqs.push(base*h);
        }
      });
      // unique + limit
      freqs = Array.from(new Set(freqs)).filter(f=>f<4000);
      if (ashEngineMode==="pro") freqs = freqs.slice(0,16);
      else freqs = freqs.slice(0,8);

      // Pink noise
      noiseNode = createPinkNoiseNode(ctx);
      const noiseGain = ctx.createGain();
      const baseNoiseLevel = ashSessionMode==="sleep" ? 0.25 : 0.32;
      noiseGain.gain.value = baseNoiseLevel;
      noiseNode.connect(noiseGain).connect(masterGain);
      noiseNode.start && noiseNode.start();

      // Tones
      toneGains = [];
      freqs.forEach(f=>{
        const osc = ctx.createOscillator();
        osc.type = "sine";
        osc.frequency.value = f;
        const g = ctx.createGain();
        g.gain.value = 0.02;
        osc.connect(g).connect(masterGain);
        osc.start();
        toneGains.push({osc,g});
      });

      runningRecipe = { freqs, elementWeights };
      document.getElementById("audioStatus").textContent =
        "Sound field running · partials: " + freqs.length + " · dominant: " + (geoMap[maxEl]||maxEl);
    }

    function stopAudioSession(){
      if (!audioCtx || !runningRecipe) return;
      if (noiseNode){ try{ noiseNode.disconnect(); }catch(e){} noiseNode=null; }
      toneGains.forEach(({osc,g})=>{
        try{ g.disconnect(); osc.stop(); }catch(e){}
      });
      toneGains = [];
      runningRecipe = null;
      document.getElementById("audioStatus").textContent = "No sound session running.";
    }

    document.getElementById("startAudioBtn").addEventListener("click", startAudioSession);
    document.getElementById("stopAudioBtn").addEventListener("click", stopAudioSession);

    document.getElementById("testToneBtn").addEventListener("click", ()=>{
      const ctx = ensureAudioCtx();
      const osc = ctx.createOscillator();
      const g = ctx.createGain();
      osc.type = "sine"; osc.frequency.value = 440;
      g.gain.value = 0.1;
      osc.connect(g).connect(masterGain);
      osc.start();
      setTimeout(()=>{ try{g.disconnect(); osc.stop();}catch(e){} }, 700);
    });

    // ---------- GEOMETRY CANVAS ----------
    const geoCanvas = document.getElementById("geoCanvas");
    const gctx = geoCanvas.getContext("2d");
    function drawGeoFrame(){
      const w = geoCanvas.width;
      const h = geoCanvas.height;
      gctx.clearRect(0,0,w,h);
      gctx.save();
      gctx.translate(w/2,h/2);
      const t = performance.now()/1000;
      const r = Math.min(w,h)*0.28;
      const sidesMap = {fire:4, earth:6, air:8, water:12, aether:5, field:16};
      let dominant = "fire";
      if (ashLastCurrentProfile){
        let max=0;
        Object.keys(ashLastCurrentProfile).forEach(k=>{
          if (ashLastCurrentProfile[k]>max){max=ashLastCurrentProfile[k]; dominant=k;}
        });
      }
      const sides = sidesMap[dominant] || 6;
      gctx.rotate(t*0.3 * (ashEngineMode==="pro"?1.7:1.0));
      gctx.beginPath();
      for (let i=0;i<sides;i++){
        const ang = i*2*Math.PI/sides;
        const x = r*Math.cos(ang);
        const y = r*Math.sin(ang);
        if (i===0) gctx.moveTo(x,y); else gctx.lineTo(x,y);
      }
      gctx.closePath();
      gctx.strokeStyle = "rgba(127,90,240,0.9)";
      gctx.lineWidth = 2;
      gctx.stroke();
      gctx.restore();
      requestAnimationFrame(drawGeoFrame);
    }
    function resizeCanvas(){
      geoCanvas.width = geoCanvas.clientWidth * window.devicePixelRatio;
      geoCanvas.height = geoCanvas.clientHeight * window.devicePixelRatio;
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();
    requestAnimationFrame(drawGeoFrame);
  </script>
</body>
</html>
